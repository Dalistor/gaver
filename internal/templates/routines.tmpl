package routines

import (
	"log"
	"time"

	"{{.ProjectName}}/config/database"
)

// Routine representa uma tarefa agendada
type Routine struct {
	Name     string
	Interval time.Duration
	Task     func()
}

// Manager gerencia todas as rotinas
type Manager struct {
	routines []Routine
	stopChan chan bool
}

// NewManager cria um novo gerenciador de rotinas
func NewManager() *Manager {
	return &Manager{
		routines: []Routine{},
		stopChan: make(chan bool),
	}
}

// Register registra uma nova rotina
func (m *Manager) Register(name string, interval time.Duration, task func()) {
	m.routines = append(m.routines, Routine{
		Name:     name,
		Interval: interval,
		Task:     task,
	})
}

// Start inicia todas as rotinas registradas
func (m *Manager) Start() {
	log.Println("ðŸ”„ Iniciando rotinas...")

	for _, routine := range m.routines {
		go m.runRoutine(routine)
		log.Printf("  âœ“ Rotina '%s' iniciada (executa a cada %v)\n", routine.Name, routine.Interval)
	}
}

// Stop para todas as rotinas
func (m *Manager) Stop() {
	log.Println("ðŸ›‘ Parando rotinas...")
	close(m.stopChan)
}

// runRoutine executa uma rotina em loop
func (m *Manager) runRoutine(routine Routine) {
	ticker := time.NewTicker(routine.Interval)
	defer ticker.Stop()

	for {
		select {
		case <-ticker.C:
			log.Printf("â° Executando rotina '%s'...", routine.Name)
			
			// Executa a tarefa com recuperaÃ§Ã£o de panic
			func() {
				defer func() {
					if r := recover(); r != nil {
						log.Printf("âŒ Erro na rotina '%s': %v", routine.Name, r)
					}
				}()
				routine.Task()
			}()
			
		case <-m.stopChan:
			log.Printf("Rotina '%s' parada", routine.Name)
			return
		}
	}
}

// RegisterDefaultRoutines registra as rotinas padrÃ£o do sistema
func (m *Manager) RegisterDefaultRoutines() {
	// Exemplo 1: Limpeza de dados antigos a cada 24 horas
	// m.Register("cleanup_old_data", 24*time.Hour, func() {
	// 	log.Println("Limpando dados antigos...")
	// 	
	// 	// Exemplo: deletar registros com mais de 30 dias
	// 	cutoffDate := time.Now().AddDate(0, 0, -30)
	// 	result := database.DB.Where("created_at < ?", cutoffDate).Delete(&YourModel{})
	// 	
	// 	if result.Error != nil {
	// 		log.Printf("Erro ao limpar dados: %v", result.Error)
	// 		return
	// 	}
	// 	
	// 	log.Printf("âœ“ %d registros antigos removidos", result.RowsAffected)
	// })

	// Exemplo 2: SincronizaÃ§Ã£o de dados a cada 1 hora
	// m.Register("sync_external_data", 1*time.Hour, func() {
	// 	log.Println("Sincronizando dados externos...")
	// 	
	// 	// Exemplo: buscar dados de API externa
	// 	// resp, err := http.Get("https://api.exemplo.com/data")
	// 	// if err != nil {
	// 	// 	log.Printf("Erro ao buscar dados: %v", err)
	// 	// 	return
	// 	// }
	// 	// defer resp.Body.Close()
	// 	
	// 	// // Processar e salvar dados
	// 	// // ...
	// 	
	// 	log.Println("âœ“ SincronizaÃ§Ã£o concluÃ­da")
	// })

	// Exemplo 3: Envio de emails pendentes a cada 5 minutos
	// m.Register("send_pending_emails", 5*time.Minute, func() {
	// 	log.Println("Verificando emails pendentes...")
	// 	
	// 	var pendingEmails []Email
	// 	err := database.DB.Where("status = ?", "pending").Limit(10).Find(&pendingEmails).Error
	// 	
	// 	if err != nil {
	// 		log.Printf("Erro ao buscar emails: %v", err)
	// 		return
	// 	}
	// 	
	// 	for _, email := range pendingEmails {
	// 		// Enviar email
	// 		// err := SendEmail(email.To, email.Subject, email.Body)
	// 		// if err == nil {
	// 		// 	database.DB.Model(&email).Update("status", "sent")
	// 		// }
	// 	}
	// 	
	// 	log.Printf("âœ“ %d emails processados", len(pendingEmails))
	// })

	// Exemplo 4: GeraÃ§Ã£o de relatÃ³rios diÃ¡rios Ã s 00:00
	// m.Register("daily_reports", 24*time.Hour, func() {
	// 	log.Println("Gerando relatÃ³rios diÃ¡rios...")
	// 	
	// 	// Calcular estatÃ­sticas do dia anterior
	// 	yesterday := time.Now().AddDate(0, 0, -1)
	// 	startOfDay := time.Date(yesterday.Year(), yesterday.Month(), yesterday.Day(), 0, 0, 0, 0, yesterday.Location())
	// 	endOfDay := startOfDay.Add(24 * time.Hour)
	// 	
	// 	var count int64
	// 	database.DB.Model(&YourModel{}).
	// 		Where("created_at BETWEEN ? AND ?", startOfDay, endOfDay).
	// 		Count(&count)
	// 	
	// 	log.Printf("âœ“ RelatÃ³rio gerado: %d novos registros no dia %s", count, yesterday.Format("02/01/2006"))
	// })

	// Exemplo 5: VerificaÃ§Ã£o de saÃºde do sistema a cada 30 segundos
	m.Register("health_check", 30*time.Second, func() {
		// Verifica conexÃ£o com banco de dados
		sqlDB, err := database.DB.DB()
		if err != nil {
			log.Printf("âŒ Erro ao verificar banco: %v", err)
			return
		}
		
		if err := sqlDB.Ping(); err != nil {
			log.Printf("âŒ Banco de dados nÃ£o estÃ¡ respondendo: %v", err)
			return
		}
		
		log.Println("âœ“ Sistema saudÃ¡vel")
	})

	// Adicione suas prÃ³prias rotinas aqui!
	// m.Register("nome_da_rotina", intervalo, func() {
	// 	// Seu cÃ³digo aqui
	// })
}

