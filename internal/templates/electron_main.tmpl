/**
 * Electron main process
 * https://www.electronjs.org/docs/latest/tutorial/process-model#the-main-process
 */

const { app, BrowserWindow } = require('electron')
const path = require('path')
const { spawn } = require('child_process')
const fs = require('fs')

let mainWindow
let serverProcess = null

// Detectar modo dev vs produ√ß√£o
// No modo dev, o servidor Go j√° est√° rodando via 'gaver serve'
// No modo produ√ß√£o, precisamos iniciar o servidor embutido
const isDev = process.env.NODE_ENV === 'development' || !app.isPackaged

// Iniciar servidor Go (apenas em produ√ß√£o)
function startGoServer() {
  // No modo dev, o servidor j√° est√° rodando, n√£o iniciar
  if (isDev) {
    console.log('Modo dev: servidor Go j√° est√° rodando via gaver serve')
    return
  }

  try {
    // Obter diret√≥rio de dados do app para SQLite
    const userDataPath = app.getPath('userData')
    const appDataDir = path.join(userDataPath, 'data')
    
    // Criar diret√≥rio se n√£o existir
    if (!fs.existsSync(appDataDir)) {
      fs.mkdirSync(appDataDir, { recursive: true })
    }
    
    // Verificar se existe banco embutido e copiar para diret√≥rio de dados
    // Quando empacotado, os arquivos podem estar em resources/ (fora do asar)
    // Quando n√£o empacotado, est√£o no mesmo diret√≥rio do electron-main.js
    const isInAsar = __dirname.includes('app.asar')
    let embeddedDBPath = null
    
    if (isInAsar) {
      // Dentro do asar, procurar em resources/ (fora do asar)
      // process.resourcesPath aponta para o diret√≥rio resources/
      embeddedDBPath = path.join(process.resourcesPath, 'database.db')
      console.log('App empacotado: procurando banco em resources/', embeddedDBPath)
    } else {
      // N√£o empacotado, procurar no mesmo diret√≥rio
      embeddedDBPath = path.join(__dirname, 'database.db')
      console.log('App n√£o empacotado: procurando banco em', embeddedDBPath)
    }
    
    // Usar nome do projeto ou 'app' como padr√£o
    const dbName = '{{.ProjectName}}' || 'app'
    const finalDBPath = path.join(appDataDir, dbName + '.db')
    
    if (embeddedDBPath && fs.existsSync(embeddedDBPath) && !fs.existsSync(finalDBPath)) {
      try {
        fs.copyFileSync(embeddedDBPath, finalDBPath)
        console.log('‚úì Banco SQLite embutido copiado para:', finalDBPath)
      } catch (err) {
        console.error('Erro ao copiar banco SQLite embutido:', err)
      }
    } else if (embeddedDBPath && !fs.existsSync(embeddedDBPath)) {
      console.log('‚ÑπÔ∏è  Banco embutido n√£o encontrado em:', embeddedDBPath)
      console.log('   O banco ser√° criado automaticamente em:', finalDBPath)
    }
    
    // Caminho do bin√°rio do servidor
    // Quando empacotado, procurar em resources/ (fora do asar)
    // Quando n√£o empacotado, procurar no mesmo diret√≥rio do electron-main.js
    let serverPath = null
    let serverPathExe = null
    
    if (isInAsar) {
      // Dentro do asar, procurar em resources/ (fora do asar)
      serverPath = path.join(process.resourcesPath, 'server')
      serverPathExe = path.join(process.resourcesPath, 'server.exe')
      console.log('App empacotado: procurando servidor em resources/')
    } else {
      // N√£o empacotado, procurar no mesmo diret√≥rio
      serverPath = path.join(__dirname, 'server')
      serverPathExe = path.join(__dirname, 'server.exe')
      console.log('App n√£o empacotado: procurando servidor em', __dirname)
    }
    
    // Verificar qual bin√°rio existe (Windows usa .exe)
    let executablePath = null
    if (process.platform === 'win32') {
      if (fs.existsSync(serverPathExe)) {
        executablePath = serverPathExe
      }
    } else {
      if (fs.existsSync(serverPath)) {
        executablePath = serverPath
      }
    }

    if (!executablePath) {
      console.warn('Servidor Go n√£o encontrado. Continuando sem servidor...')
      return
    }

    // Tornar execut√°vel (Unix/Linux/Mac)
    if (process.platform !== 'win32') {
      fs.chmodSync(executablePath, '755')
    }

    // Configurar vari√°veis de ambiente para o servidor Go
    const serverEnv = {
      ...process.env,
      APP_DATA_DIR: appDataDir
    }
    
    // Se existe .env em resources/, adicionar ao PATH ou usar vari√°vel para o servidor encontrar
    // O servidor Go procura .env no diret√≥rio atual de execu√ß√£o
    const envPath = isInAsar 
      ? path.join(process.resourcesPath, '.env')
      : path.join(__dirname, '.env')
    
    if (fs.existsSync(envPath)) {
      console.log('‚úì Arquivo .env encontrado em:', envPath)
      // O servidor Go vai procurar o .env no diret√≥rio de trabalho (cwd)
      // Vamos definir o cwd como o diret√≥rio onde est√° o .env
    } else {
      console.log('‚ÑπÔ∏è  Arquivo .env n√£o encontrado - servidor usar√° vari√°veis de ambiente do sistema')
    }
    
    // Definir diret√≥rio de trabalho como o diret√≥rio do servidor (onde est√° o .env)
    const serverCwd = isInAsar 
      ? process.resourcesPath  // resources/ cont√©m .env e server.exe
      : path.dirname(executablePath)  // Mesmo diret√≥rio do execut√°vel
    
    // Iniciar o servidor com APP_DATA_DIR configurado
    // Usar 'pipe' ao inv√©s de 'inherit' para esconder o console CMD
    serverProcess = spawn(executablePath, [], {
      cwd: serverCwd,
      stdio: 'pipe', // Esconde o console CMD
      detached: false,
      env: serverEnv
    })
    
    // Opcionalmente, redirecionar stdout/stderr para logs (se necess√°rio)
    // serverProcess.stdout.on('data', (data) => { console.log(`Server: ${data}`) })
    // serverProcess.stderr.on('data', (data) => { console.error(`Server Error: ${data}`) })

    serverProcess.on('error', (err) => {
      console.error('Erro ao iniciar servidor Go:', err)
    })

    serverProcess.on('exit', (code, signal) => {
      console.log(`Servidor Go encerrado. C√≥digo: ${code}, Sinal: ${signal}`)
      serverProcess = null
    })

    console.log('Servidor Go iniciado com sucesso')
    console.log('APP_DATA_DIR configurado:', appDataDir)
  } catch (error) {
    console.error('Erro ao iniciar servidor Go:', error)
  }
}

// Parar servidor Go
function stopGoServer() {
  if (serverProcess) {
    console.log('Parando servidor Go...')
    if (process.platform === 'win32') {
      // Windows: usar taskkill
      spawn('taskkill', ['/pid', serverProcess.pid, '/f', '/t'])
    } else {
      // Unix/Linux/Mac: enviar SIGTERM
      serverProcess.kill('SIGTERM')
    }
    serverProcess = null
  }
}

function createWindow () {
  /**
   * Initial window options
   */
  mainWindow = new BrowserWindow({
    width: 1000,
    height: 600,
    useContentSize: true,
    // Remover barra de menu em produ√ß√£o
    autoHideMenuBar: !isDev, // Esconder barra de menu em produ√ß√£o
    frame: true, // Manter frame da janela
    webPreferences: {
      // Use pluginOptions.nodeIntegration, leave this alone
      // See nklayman.github.io/vue-cli-plugin-electron-builder/guide/security.html#node-integration for more info
      nodeIntegration: process.env.ELECTRON_NODE_INTEGRATION,
      contextIsolation: !process.env.ELECTRON_NODE_INTEGRATION
    }
  })
  
  // Remover menu completamente em produ√ß√£o
  if (!isDev) {
    mainWindow.setMenuBarVisibility(false)
  }

  // Abrir DevTools apenas em desenvolvimento
  if (isDev || process.env.DEBUGGING) {
    // if on DEV or Production with debug enabled
    mainWindow.webContents.openDevTools()
  } else {
    // Em produ√ß√£o, n√£o abrir DevTools
    mainWindow.webContents.on('devtools-opened', () => {
      mainWindow.webContents.closeDevTools()
    })
  }

  // Configurar URL baseado no modo (dev ou produ√ß√£o)
  // O Quasar automaticamente define process.env.APP_URL:
  // - No dev: aponta para o Quasar dev server (ex: http://localhost:9000)
  // - No build: aponta para os arquivos est√°ticos (file://...)
  // O Quasar dev server faz proxy das requisi√ß√µes /api para o servidor Go
  let appUrl = process.env.APP_URL
  
  if (!appUrl) {
    // Fallback caso APP_URL n√£o esteja definido
    if (isDev) {
      // No dev, tentar porta padr√£o do Quasar dev server
      // O Quasar geralmente usa a porta 9000 para Electron no dev
      appUrl = 'http://localhost:9000'
      console.warn('APP_URL n√£o definido, usando fallback para dev:', appUrl)
    } else {
      // No build, quando empacotado com electron-builder:
      // - app.getAppPath() retorna o caminho do app.asar (ex: .../resources/app.asar)
      // - O index.html est√° em app.asar/dist/electron/UnPackaged/index.html
      const appPath = app.getAppPath()
      const isInAsar = appPath.includes('app.asar')
      
      let foundPath = null
      
      // Tentar diferentes estruturas de build do Quasar/electron-builder
      const possiblePaths = [
        // Dentro do app.asar (estrutura padr√£o do Quasar com electron-builder)
        path.join(appPath, 'dist', 'electron', 'UnPackaged', 'index.html'),
        // Estrutura alternativa (sem dist)
        path.join(appPath, 'electron', 'UnPackaged', 'index.html'),
        // Diretamente no asar
        path.join(appPath, 'index.html'),
        // Estrutura do packager antigo
        path.join(appPath, 'dist', 'electron', 'UnPackaged', 'index.html'),
        // Fallback: mesmo diret√≥rio do electron-main.js (dentro do asar)
        path.join(__dirname, 'index.html'),
        // Tentar um n√≠vel acima do electron-main.js
        path.join(__dirname, '..', 'index.html'),
        path.join(__dirname, '..', 'dist', 'electron', 'UnPackaged', 'index.html'),
      ]
      
      console.log('üîç Procurando index.html...')
      console.log('app.getAppPath():', appPath)
      console.log('__dirname:', __dirname)
      console.log('isInAsar:', isInAsar)
      
      for (const possiblePath of possiblePaths) {
        console.log('Tentando:', possiblePath)
        try {
          if (fs.existsSync(possiblePath)) {
            foundPath = possiblePath
            console.log('‚úì Arquivo index.html encontrado em:', foundPath)
            break
          }
        } catch (err) {
          console.log('Erro ao verificar:', possiblePath, err.message)
        }
      }
      
      if (foundPath) {
        // Converter caminho Windows para formato file:// correto
        // Se estiver dentro do asar, usar o caminho relativo
        if (isInAsar) {
          // Dentro do asar, usar caminho relativo ao app.asar
          const relativePath = foundPath.replace(appPath + path.sep, '')
          appUrl = `file://${foundPath.replace(/\\/g, '/')}`
        } else {
          appUrl = `file://${foundPath.replace(/\\/g, '/')}`
        }
        console.log('‚úì Usando caminho encontrado:', appUrl)
      } else {
        // √öltimo fallback: usar caminho padr√£o do Quasar dentro do asar
        // O Quasar geralmente coloca index.html em dist/electron/UnPackaged/
        const defaultPath = path.join(appPath, 'dist', 'electron', 'UnPackaged', 'index.html')
        appUrl = `file://${defaultPath.replace(/\\/g, '/')}`
        console.warn('‚ö†Ô∏è  Arquivo index.html n√£o encontrado, usando caminho padr√£o do Quasar')
        console.warn('Caminho padr√£o:', appUrl)
        console.warn('Se n√£o funcionar, verifique a estrutura do build em:', appPath)
      }
    }
  }
  
  if (isDev) {
    console.log('Modo dev: carregando frontend do Quasar dev server')
    console.log('O Quasar dev server faz proxy de /api para o servidor Go em http://localhost:' + (process.env.VITE_SERVER_PORT || '8080'))
  } else {
    console.log('Modo produ√ß√£o: carregando arquivos est√°ticos')
  }

  console.log('Carregando URL:', appUrl)
  
  // No dev, aguardar um pouco para garantir que o Quasar dev server est√° pronto
  if (isDev) {
    // Usar setTimeout para dar tempo do Quasar dev server iniciar
    setTimeout(() => {
      mainWindow.loadURL(appUrl)
    }, 1000)
  } else {
    // No build, tentar carregar e tratar erros
    mainWindow.loadURL(appUrl).catch((err) => {
      console.error('Erro ao carregar URL:', err)
      console.error('URL tentada:', appUrl)
      // Tentar carregar p√°gina de erro
      mainWindow.loadURL(`data:text/html,<html><body><h1>Erro ao carregar aplica√ß√£o</h1><p>URL: ${appUrl}</p><p>Erro: ${err.message}</p><p>__dirname: ${__dirname}</p><p>Verifique o console para mais detalhes.</p></body></html>`)
    })
  }

  mainWindow.on('closed', () => {
    mainWindow = null
  })
}

app.whenReady().then(() => {
  // Iniciar servidor Go antes de criar a janela
  startGoServer()
  
  createWindow()

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow()
    }
  })
})

app.on('window-all-closed', () => {
  // Parar servidor Go antes de sair
  stopGoServer()
  
  if (process.platform !== 'darwin') {
    app.quit()
  }
})

app.on('before-quit', () => {
  // Garantir que o servidor seja parado
  stopGoServer()
})

