package {{.PackageName}};

import android.os.Bundle;
import android.util.Log;
import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.IOException;

import com.getcapacitor.BridgeActivity;

public class MainActivity extends BridgeActivity {
    private static final String TAG = "MainActivity";
    private Process serverProcess;

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        
        // Iniciar servidor Go em thread separada
        new Thread(() -> {
            try {
                startGoServer();
            } catch (Exception e) {
                Log.e(TAG, "Erro ao iniciar servidor Go", e);
            }
        }).start();
    }

    private void startGoServer() {
        try {
            // Caminho do binário do servidor Go no assets
            String serverBinary = "server";
            
            // Copiar binário do assets para o diretório de dados do app
            File dataDir = getApplicationContext().getFilesDir();
            File serverFile = new File(dataDir, serverBinary);
            
            if (!serverFile.exists()) {
                // Copiar do assets
                copyAssetToFile(serverBinary, serverFile);
                // Tornar executável
                serverFile.setExecutable(true);
            }

            // Iniciar o servidor
            ProcessBuilder pb = new ProcessBuilder(serverFile.getAbsolutePath());
            pb.directory(dataDir);
            pb.redirectErrorStream(true);
            
            serverProcess = pb.start();
            
            Log.i(TAG, "Servidor Go iniciado com sucesso");
            
        } catch (Exception e) {
            Log.e(TAG, "Erro ao iniciar servidor Go: " + e.getMessage(), e);
        }
    }

    private void copyAssetToFile(String assetName, File destFile) throws IOException {
        InputStream is = getAssets().open(assetName);
        FileOutputStream fos = new FileOutputStream(destFile);
        
        byte[] buffer = new byte[8192];
        int bytesRead;
        while ((bytesRead = is.read(buffer)) != -1) {
            fos.write(buffer, 0, bytesRead);
        }
        
        fos.close();
        is.close();
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        
        // Parar servidor Go quando o app fechar
        if (serverProcess != null) {
            serverProcess.destroy();
            try {
                serverProcess.waitFor();
            } catch (InterruptedException e) {
                Log.e(TAG, "Erro ao aguardar término do servidor", e);
            }
        }
    }
}

